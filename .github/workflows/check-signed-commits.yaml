name: Check signed commits in PR
on: pull_request_target

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-signed-commits:
    name: Check signed commits in PR
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Check signed commits (excluding verified bots)
        id: check-signed
        continue-on-error: true
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Get all commits in the PR
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const unsignedCommits = [];
            let humanCommitCount = 0;
            let botCommitCount = 0;
            let signedHumanCount = 0;

            for (const commit of commits) {
              const author = commit.author;
              const commitData = commit.commit;

              // Check if author is a bot
              const isBot = author && author.type === 'Bot';

              if (isBot) {
                botCommitCount++;
                continue;
              }

              humanCommitCount++;

              // Use GitHub's verification status from the API
              const isVerified = commitData.verification && commitData.verification.verified;

              if (isVerified) {
                signedHumanCount++;
              } else {
                const authorName = author?.login || commitData.author.name;
                unsignedCommits.push({
                  hash: commit.sha,
                  author: authorName,
                  reason: commitData.verification?.reason || 'no signature'
                });
              }
            }

            // Set outputs
            core.setOutput('has_unsigned_commits', unsignedCommits.length > 0 ? 'true' : 'false');
            core.setOutput('unsigned_count', unsignedCommits.length.toString());

            if (unsignedCommits.length > 0) {
              core.setOutput('unsigned_commits', JSON.stringify(unsignedCommits));
            }

            // Fail the step if there are unsigned human commits (but continue-on-error is set)
            if (unsignedCommits.length > 0) {
              core.setFailed(`Found ${unsignedCommits.length} unsigned commit(s) from human contributors`);
            }

      - name: Comment on unsigned commits
        if: steps.check-signed.outputs.has_unsigned_commits == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const unsignedCommits = JSON.parse(`${{ steps.check-signed.outputs.unsigned_commits }}`);
            const unsignedCount = '${{ steps.check-signed.outputs.unsigned_count }}';

            // Build commit list for comment
            const commitList = unsignedCommits.map(c => {
              const reasonText = c.reason ? ` (${c.reason})` : '';
              return `- \`${c.hash.substring(0, 7)}\` by **${c.author}**${reasonText}`;
            }).join('\n');

            const comment = `## ⚠️ Unsigned Commits Detected

            This pull request contains **${unsignedCount}** unsigned human commit(s).

            **Note:** Bot commits are automatically verified via GitHub API and excluded from this check.

            ### Unsigned Commits

            ${commitList}

            ### What does this mean?

            Signed commits help ensure the authenticity and traceability of contributions. They allow us to verify that commits actually came from the stated author, even if GitHub accounts are deleted or modified in the future.

            ### Current Policy (Grace Period)

            **This is currently a warning only.** We are in a transition period to give all contributors time to set up commit signing.

            After this grace period, **all commits will be required to be signed** before PRs can be merged.

            ### How to sign your commits

            Please see our [Contributing Guide](../blob/main/CONTRIBUTING.md#setting-up-your-development-environment) for detailed instructions on setting up commit signing.

            ### Resources

            - [Contributing Guide: Development Setup](../blob/main/CONTRIBUTING.md#setting-up-your-development-environment)
            - [GitHub Docs: About Commit Signature Verification](https://docs.github.com/en/authentication/managing-commit-signature-verification/about-commit-signature-verification)

            ---

            _This check will become mandatory in the future. Please start signing your commits now to avoid issues later._`;

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

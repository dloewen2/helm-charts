name: Check signed commits in PR
on: pull_request_target

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-signed-commits:
    name: Check signed commits in PR
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Get commit information
        id: get-commits
        run: |
          # Fetch base branch for comparison
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Get all commits with hash, author name, and signature status
          # Format: HASH|AUTHOR|SIGNATURE_STATUS
          # Signature status: G=good, B=bad, U=untrusted, X=expired, Y=good from expired key, R=good from revoked key, E=cannot be checked, N=no signature
          COMMITS=$(git log origin/${{ github.event.pull_request.base.ref }}..HEAD --format="%H|%an|%G?")

          {
            echo 'commits<<EOF'
            echo "$COMMITS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Check signed commits (excluding verified bots)
        id: check-signed
        continue-on-error: true
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const commitsData = `${{ steps.get-commits.outputs.commits }}`;

            const commits = commitsData.trim().split('\n')
              .filter(line => line.length > 0)
              .map(line => {
                const [hash, author, sigStatus] = line.split('|');
                return { hash, author, sigStatus };
              });

            // Get unique authors to minimize API calls
            const uniqueAuthors = [...new Set(commits.map(c => c.author))];

            // Check which authors are bots via GitHub API
            const botAuthors = new Set();
            const humanAuthors = new Set();

            for (const author of uniqueAuthors) {
              try {
                // GitHub API requires the full username including [bot] suffix
                const { data: user } = await github.rest.users.getByUsername({
                  username: author
                });

                if (user.type === 'Bot') {
                  botAuthors.add(author);
                } else {
                  humanAuthors.add(author);
                }
              } catch (error) {
                // If user not found or API error, treat as human (fail-safe)
                humanAuthors.add(author);
              }
            }

            const unsignedCommits = [];
            let humanCommitCount = 0;
            let botCommitCount = 0;
            let signedHumanCount = 0;

            for (const commit of commits) {
              const isBot = botAuthors.has(commit.author);

              if (isBot) {
                botCommitCount++;
                continue;
              }

              humanCommitCount++;
              const isSigned = commit.sigStatus === 'G' || commit.sigStatus === 'U';

              if (isSigned) {
                signedHumanCount++;
              } else {
                unsignedCommits.push(commit);
              }
            }

            // Set outputs
            core.setOutput('has_unsigned_commits', unsignedCommits.length > 0 ? 'true' : 'false');
            core.setOutput('unsigned_count', unsignedCommits.length.toString());

            if (unsignedCommits.length > 0) {
              core.setOutput('unsigned_commits', JSON.stringify(unsignedCommits));
            }

            // Fail the step if there are unsigned human commits (but continue-on-error is set)
            if (unsignedCommits.length > 0) {
              core.setFailed(`Found ${unsignedCommits.length} unsigned commit(s) from human contributors`);
            }

      - name: Comment on unsigned commits
        if: steps.check-signed.outputs.has_unsigned_commits == 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const unsignedCommits = JSON.parse(`${{ steps.check-signed.outputs.unsigned_commits }}`);
            const unsignedCount = '${{ steps.check-signed.outputs.unsigned_count }}';

            // Build commit list for comment
            const commitList = unsignedCommits.map(c =>
              `- \`${c.hash.substring(0, 7)}\` by **${c.author}**`
            ).join('\n');

            const comment = `## ⚠️ Unsigned Commits Detected

            This pull request contains **${unsignedCount}** unsigned human commit(s).

            **Note:** Bot commits are automatically verified via GitHub API and excluded from this check.

            ### Unsigned Commits

            ${commitList}

            ### What does this mean?

            Signed commits help ensure the authenticity and traceability of contributions. They allow us to verify that commits actually came from the stated author, even if GitHub accounts are deleted or modified in the future.

            ### Current Policy (Grace Period)

            **This is currently a warning only.** We are in a transition period to give all contributors time to set up commit signing.

            After this grace period, **all commits will be required to be signed** before PRs can be merged.

            ### How to sign your commits

            Please see our [Contributing Guide](../blob/main/CONTRIBUTING.md#setting-up-your-development-environment) for detailed instructions on setting up commit signing.

            ### Resources

            - [Contributing Guide: Development Setup](../blob/main/CONTRIBUTING.md#setting-up-your-development-environment)
            - [GitHub Docs: About Commit Signature Verification](https://docs.github.com/en/authentication/managing-commit-signature-verification/about-commit-signature-verification)

            ---

            _This check will become mandatory in the future. Please start signing your commits now to avoid issues later._`;

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

name: Release Charts

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip actual release)'
        required: false
        type: boolean
        default: false
      chart:
        description: 'Specific chart to release (optional, e.g. "charts/my-chart")'
        required: false
        type: string

jobs:
  release:
    permissions:
      contents: write
      packages: write
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          # Setup SSH key for signing in a secure temp location
          SIGN_KEY_FILE=$(mktemp)
          echo "${{ secrets.BOT_SSH_SIGNING_KEY }}" > "$SIGN_KEY_FILE"
          chmod 600 "$SIGN_KEY_FILE"

          # Store the key file path for later steps
          echo "SIGN_KEY_FILE=$SIGN_KEY_FILE" >> $GITHUB_ENV

          # Configure git with SSH signing
          git config user.name 'cloudpirates-bot'
          git config user.email 'cloudpirates-bot@users.noreply.github.com'
          git config gpg.format ssh
          git config user.signingkey "$SIGN_KEY_FILE"
          git config commit.gpgsign true

      - name: Login to Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ vars.REGISTRY }}
          username: ${{ secrets.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Login to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update chart dependencies
        run: |
          set -euo pipefail
          echo "Updating dependencies for all charts..."
          for chart_dir in charts/*; do
            if [ -f "$chart_dir/Chart.yaml" ]; then
              echo "Processing $chart_dir..."
              if grep -q "^dependencies:" "$chart_dir/Chart.yaml"; then
                echo "  â†’ Updating dependencies for $chart_dir"
                helm dependency update "$chart_dir"
              else
                echo "  â†’ No dependencies found, skipping"
              fi
            fi
          done

      - name: Detect changed charts
        id: detect-changed-charts
        run: |
          set -euo pipefail

          echo "Detecting charts that actually need to be released..."

          CHANGED_CHARTS=""

          for chart_dir in charts/*; do
            if [ ! -f "$chart_dir/Chart.yaml" ]; then
              echo "Skipping $chart_dir (no Chart.yaml)"
              continue
            fi

            CHART_NAME=$(basename "$chart_dir")
            CHART_VERSION=$(yq eval '.version' "$chart_dir/Chart.yaml")

            # Check if this specific chart version already has a tag/release
            if git tag -l | grep -q "^${CHART_NAME}-${CHART_VERSION}$"; then
              echo "âœ“ $CHART_NAME-$CHART_VERSION already released, skipping"
              continue
            fi

            # Check if there are actual changes to this chart since its last release
            LAST_CHART_TAG=$(git tag -l "${CHART_NAME}-*" | sort -V | tail -1)

            if [ -n "$LAST_CHART_TAG" ]; then
              # Check if there are changes to this chart since its last tag
              CHART_CHANGES=$(git diff --name-only "$LAST_CHART_TAG" HEAD -- "$chart_dir/" 2>/dev/null || echo "")
              if [ -z "$CHART_CHANGES" ]; then
                echo "âœ“ $CHART_NAME: No changes since $LAST_CHART_TAG, skipping"
                continue
              else
                echo "ðŸ“¦ $CHART_NAME: Changes detected since $LAST_CHART_TAG"
                echo "   Changed files: $CHART_CHANGES"
              fi
            else
              echo "ðŸ†• $CHART_NAME: New chart (no previous tags)"
            fi

            # Add to changed charts list
            if [ -z "$CHANGED_CHARTS" ]; then
              CHANGED_CHARTS="$CHART_NAME"
            else
              CHANGED_CHARTS="$CHANGED_CHARTS,$CHART_NAME"
            fi

            echo "ðŸš€ Will release: $CHART_NAME-$CHART_VERSION"
          done

          echo "changed_charts=$CHANGED_CHARTS" >> $GITHUB_OUTPUT

          if [ -n "$CHANGED_CHARTS" ]; then
            echo "ðŸ“‹ Summary: Will release charts: $CHANGED_CHARTS"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“‹ Summary: No charts need to be released"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Run chart-releaser
        id: chart-releaser
        if: ${{ steps.detect-changed-charts.outputs.has_changes == 'true' }}
        uses: helm/chart-releaser-action@cae68fefc6b5f367a0275617c9f83181ba54714f # v1.7.0
        with:
          skip_existing: true
          charts_dir: charts
          charts_repo_url: https://charts.cloudpirates.io
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Package manually specified chart
        if: ${{ github.event.inputs.chart != '' }}
        run: |
          set -euo pipefail
          CHART_DIR="${{ github.event.inputs.chart }}"

          if [ ! -d "$CHART_DIR" ]; then
            echo "ERROR: Chart directory $CHART_DIR does not exist"
            exit 1
          fi

          # Update dependencies if they exist
          if grep -q "^dependencies:" "$CHART_DIR/Chart.yaml"; then
            echo "Updating dependencies for $CHART_DIR..."
            helm dependency update "$CHART_DIR"
          fi

          echo "Packaging chart from $CHART_DIR..."
          mkdir -p .cr-release-packages
          helm package "$CHART_DIR" --destination .cr-release-packages

          echo "Packaged charts:"
          ls -lh .cr-release-packages/

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.10.0
        if: ${{ steps.detect-changed-charts.outputs.has_changes == 'true' || github.event.inputs.chart != '' }}

      - id: github-repo-owner-name
        uses: ASzc/change-string-case-action@d0603cd0a7dd490be678164909f65c7737470a7f # v6
        with:
          string: ${{ github.repository_owner }}

      - name: Upload charts to OCI registries
        id: upload
        if: ${{ steps.detect-changed-charts.outputs.has_changes == 'true' || github.event.inputs.chart != '' }}
        env:
          COSIGN_KEY: ${{ secrets.COSIGN_KEY }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
        run: |
          set -euo pipefail

          # Determine which charts to release
          if [ -n "${{ github.event.inputs.chart }}" ]; then
            echo "Manual chart specified: ${{ github.event.inputs.chart }}"
            MANUAL_CHART="${{ github.event.inputs.chart }}"
            CHANGED_CHARTS=$(basename "$MANUAL_CHART")
          else
            CHANGED_CHARTS="${{ steps.detect-changed-charts.outputs.changed_charts }}"
          fi


          if [ -z "$CHANGED_CHARTS" ]; then
            echo "No charts to release."
            exit 0
          fi

          # Retry function for network operations
          retry() {
            local max_attempts=3
            local attempt=1
            local delay=5
            while [ $attempt -le $max_attempts ]; do
              if "$@"; then return 0; fi
              echo "Attempt $attempt failed. Retrying in ${delay}s..."
              sleep $delay
              delay=$((delay * 2))
              attempt=$((attempt + 1))
            done
            echo "ERROR: All $max_attempts attempts failed"
            return 1
          }

          echo "Logging into primary registry..."
          retry helm registry login --username $REGISTRY_USER --password ${{ secrets.REGISTRY_PASSWORD }} https://${{ vars.REGISTRY }}

          echo "Logging into GHCR..."
          retry helm registry login --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} https://ghcr.io

          RELEASED_CHARTS=""
          for CHART_NAME in ${CHANGED_CHARTS//,/ }; do
            chart_directory="charts/$CHART_NAME"
            cd "$chart_directory"

            CHART_VERSION=$(yq eval '.version' "Chart.yaml")
            APP_VERSION=$(yq eval '.appVersion' "Chart.yaml")

            echo "Pushing Helm chart $CHART_NAME-$CHART_VERSION.tgz to oci://${{ vars.REGISTRY }}/${{ vars.REPOSITORY }}"
            if retry helm push ${{ github.workspace }}/.cr-release-packages/${CHART_NAME}-${CHART_VERSION}.tgz oci://${{ vars.REGISTRY }}/${{ vars.REPOSITORY }} 2>&1 | tee ${CHART_NAME}-output.log; then
              DIGEST=$(grep -oP 'Digest:\s*\K(sha256:[a-f0-9]+)' ${CHART_NAME}-output.log || echo "")
              [ -z "$DIGEST" ] && echo "ERROR: Failed to extract digest" && cat ${CHART_NAME}-output.log && exit 1
              cosign sign -y --upload=true --key env://COSIGN_KEY ${{ vars.REGISTRY }}/${{ vars.REPOSITORY }}/${CHART_NAME}:${CHART_VERSION}@$DIGEST
              RELEASED_CHARTS="$RELEASED_CHARTS ${CHART_NAME}"
            fi

            echo "Pushing Helm chart $CHART_NAME-$CHART_VERSION.tgz to GHCR..."
            if retry helm push ${{ github.workspace }}/.cr-release-packages/${CHART_NAME}-${CHART_VERSION}.tgz oci://ghcr.io/${{ steps.github-repo-owner-name.outputs.lowercase }}/helm-charts 2>&1 | tee ${CHART_NAME}-ghcr-output.log; then
              GHCR_DIGEST=$(grep -oP 'Digest:\s*\K(sha256:[a-f0-9]+)' ${CHART_NAME}-ghcr-output.log || echo "")
              [ -z "$GHCR_DIGEST" ] && echo "ERROR: Failed to extract GHCR digest" && cat ${CHART_NAME}-ghcr-output.log && exit 1
              cosign sign -y --upload=true --key env://COSIGN_KEY ghcr.io/${{ steps.github-repo-owner-name.outputs.lowercase }}/helm-charts/${CHART_NAME}:${CHART_VERSION}@$GHCR_DIGEST
            fi

            cd ${{ github.workspace }}
          done

          echo "released_charts=$RELEASED_CHARTS" >> "$GITHUB_OUTPUT"
          echo "## ðŸ“¦ Helm Charts Released" >> $GITHUB_STEP_SUMMARY
          for chart in $RELEASED_CHARTS; do
            echo "- âœ… **$chart**" >> $GITHUB_STEP_SUMMARY
          done
          echo "### ðŸ“ Registries" >> $GITHUB_STEP_SUMMARY
          echo "- Primary: \`${{ vars.REGISTRY }}/${{ vars.REPOSITORY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- GHCR: \`ghcr.io/${{ steps.github-repo-owner-name.outputs.lowercase }}/helm-charts\`" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup signing key
        if: always()
        run: |
          if [ -n "$SIGN_KEY_FILE" ] && [ -f "$SIGN_KEY_FILE" ]; then
            rm -f "$SIGN_KEY_FILE"
            echo "Signing key cleaned up"
          fi

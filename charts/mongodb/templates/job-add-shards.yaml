{{- if .Values.shardedCluster.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "mongodb.fullname" . }}-add-shards
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "mongodb.labels" . | nindent 4 }}
    job-type: add-shards
  {{- with (include "mongodb.annotations" .) }}
  annotations:
{{- . | indent 4 }}
  {{- end }}
spec:
  backoffLimit: 10
  template:
    metadata:
      labels:
        {{- include "mongodb.selectorLabels" . | nindent 8 }}
        job-type: add-shards
    spec:
{{- with (include "mongodb.imagePullSecrets" .) }}
{{ . | nindent 6 }}
{{- end }}
      restartPolicy: OnFailure
      {{- if .Values.serviceAccount.create }}
      serviceAccountName: {{ include "mongodb.serviceAccountName" . }}
      {{- end }}
      initContainers:
        - name: copy-kubectl
          image: bitnami/kubectl:latest
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              # Copy kubectl binary to shared volume
              cp /opt/bitnami/kubectl/bin/kubectl /kubectl/kubectl
              chmod +x /kubectl/kubectl
          volumeMounts:
            - name: kubectl-bin
              mountPath: /kubectl
      containers:
        - name: add-shards
          image: {{ include "mongodb.image" . }}
          imagePullPolicy: {{ include "cloudpirates.imagePullPolicy" (dict "image" .Values.image) }}
          command:
            - /bin/bash
            - -c
            - |
              # Add kubectl to PATH
              export PATH=/kubectl:$PATH

              echo "***** Waiting for all MongoDB pods to be ready before adding shards..."

              # Build list of data pods to wait for (NOT mongos - it waits for us!)
              PODS=""
              {{- range $i := until (int .Values.shardedCluster.configsvr.replicaCount) }}
              PODS="$PODS pod/{{ include "mongodb.fullname" $ }}-configserver-{{ $i }}"
              {{- end }}
              {{- range $shardIdx := until (int .Values.shardedCluster.shards) }}
              {{- range $nodeIdx := until (int $.Values.shardedCluster.shardsvr.dataNode.replicaCount) }}
              PODS="$PODS pod/{{ include "mongodb.fullname" $ }}-shard-{{ $shardIdx }}-{{ $nodeIdx }}"
              {{- end }}
              {{- end }}

              # Wait for all data pods in parallel (mongos will start after we initialize replica sets)
              echo "Waiting for data pods (configserver + shards): $PODS"
              kubectl wait --for=condition=ready $PODS -n {{ .Release.Namespace }} --timeout=180s

              echo "***** All pods are ready, proceeding with cluster initialization..."

              # Run full initialization: replica sets + shard addition
              /opt/mongodb/init-scripts/extra-init-sharded.sh
          env:
            - name: HOSTNAME
              value: {{ include "mongodb.fullname" . }}-mongos-0
            {{- if .Values.auth.enabled }}
            - name: MONGO_INITDB_ROOT_USERNAME
              value: {{ .Values.auth.rootUsername | quote }}
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "mongodb.secretName" . }}
                  key: {{ include "mongodb.secretPasswordKey" . }}
            {{- end }}
          volumeMounts:
            - name: kubectl-bin
              mountPath: /kubectl
            - name: mongodb-init-scripts
              mountPath: /opt/mongodb/init-scripts
              readOnly: true
      volumes:
        - name: kubectl-bin
          emptyDir: {}
        - name: mongodb-init-scripts
          configMap:
            name: {{ include "mongodb.fullname" . }}-init-scripts
            defaultMode: 0755
{{- end }}

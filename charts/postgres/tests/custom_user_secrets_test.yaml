suite: Custom user secrets
templates:
  - templates/statefulset.yaml

tests:
  - it: should reference the generated secret
    set:
      customUser.name: "my-user"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: "RELEASE-NAME-postgres-custom-user-credentials"
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.key
          value: "CUSTOM_DB"
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.name
          value: "RELEASE-NAME-postgres-custom-user-credentials"
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.key
          value: "CUSTOM_USER"

  - it: should reference the existing secret
    set:
      customUser.existingSecret: "my-existing-secret"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: "my-existing-secret"
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.key
          value: "CUSTOM_DB"
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.name
          value: "my-existing-secret"
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.key
          value: "CUSTOM_USER"
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.name
          value: "my-existing-secret"
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.key
          value: "CUSTOM_PASSWORD"

  - it: should reference all existing secret keys
    set:
      customUser.existingSecret: "my-custom-existing-secret"
      customUser.secretKeys:
        name: "my-user-key"
        database: "my-database-key"
        password: "my-password-key"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.name
          value: "my-custom-existing-secret"
      - equal:
          path: spec.template.spec.containers[0].env[3].valueFrom.secretKeyRef.key
          value: "my-database-key"
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.name
          value: "my-custom-existing-secret"
      - equal:
          path: spec.template.spec.containers[0].env[4].valueFrom.secretKeyRef.key
          value: "my-user-key"
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.name
          value: "my-custom-existing-secret"
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.key
          value: "my-password-key"

  - it: should reference password secret key only
    set:
      customUser:
        existingSecret: "my-password-only-secret"
        name: "my-username"
        database: "my-database"
        secretKeys:
          name: ""
          database: ""
          password: "my-password-key"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[3].value
          value: "my-database"
      - equal:
          path: spec.template.spec.containers[0].env[4].value
          value: "my-username"
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.name
          value: "my-password-only-secret"
      - equal:
          path: spec.template.spec.containers[0].env[5].valueFrom.secretKeyRef.key
          value: "my-password-key"

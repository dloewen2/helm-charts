suite: test zookeeper specific parameters

tests:
  - it: should set the correct replica count
    template: statefulset.yaml
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use the correct image repository and tag
    template: statefulset.yaml
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: "docker.io/zookeeper"

  - it: should expose the correct client port
    template: service.yaml
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 2181

  - it: should create a normal service (not headless)
    template: service.yaml
    documentIndex: 0
    asserts:
      - notEqual:
          path: spec.clusterIP
          value: None

  - it: should create a headless service
    template: service.yaml
    documentIndex: 1
    asserts:
      - equal:
          path: spec.clusterIP
          value: None

  - it: should set tickTime in configmap
    template: configmap.yaml
    asserts:
      - matchRegex:
          path: data["zoo.cfg"]
          pattern: "tickTime=2000"

  - it: should create volumeClaimTemplates by default (persistence enabled)
    template: statefulset.yaml
    asserts:
      - isNotNull:
          path: spec.volumeClaimTemplates
      - equal:
          path: spec.volumeClaimTemplates[0].metadata.name
          value: data
      - equal:
          path: spec.volumeClaimTemplates[0].spec.accessModes[0]
          value: ReadWriteOnce
      - equal:
          path: spec.volumeClaimTemplates[0].spec.resources.requests.storage
          value: 8Gi
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: data

  - it: should use emptyDir when persistence is disabled
    template: statefulset.yaml
    set:
      persistence:
        enabled: false
    asserts:
      - isNull:
          path: spec.volumeClaimTemplates
      - isNotNull:
          path: spec.template.spec.volumes
      - equal:
          path: spec.template.spec.volumes[0].name
          value: data
      - isNotNull:
          path: spec.template.spec.volumes[0].emptyDir

  - it: should use existing PVC when existingClaim is set
    template: statefulset.yaml
    set:
      persistence:
        enabled: true
        existingClaim: my-existing-pvc
    asserts:
      - isNull:
          path: spec.volumeClaimTemplates
      - isNotNull:
          path: spec.template.spec.volumes
      - equal:
          path: spec.template.spec.volumes[0].name
          value: data
      - equal:
          path: spec.template.spec.volumes[0].persistentVolumeClaim.claimName
          value: my-existing-pvc